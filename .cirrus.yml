freebsd_instance:
    image_family: freebsd-12-1

task:
  configure_freebsd_script:
    - mkdir -p /usr/local/etc/pkg/repos
    - |
      cat >> /usr/local/etc/pkg/repos/FreeBSD.conf <<EOF
      FreeBSD: {
        url: "pkg+http://pkg.FreeBSD.org/\${ABI}/latest"
      }
      EOF
    - echo BATCH=yes >> /etc/make.conf
    - echo DEVELOPER=yes >> /etc/make.conf

  git_version_script: git --version
  svn_version_script: svn --version

  install_portlint_depends_script: pkg install -y portlint
  portlint_script:
    - portlint -V || true
    - cd mail/rspamd-devel && portlint -C

  portsnap_fetch_script:
   - portsnap --interactive fetch
   - date -r `cut -f 2 -d '|' /var/db/portsnap/tag`
  portsnap_extract_script: portsnap extract

  install_build_depends_script: >
    pkg install -y
    ragel cmake ninja pkgconf perl5 pcre icu libsodium hyperscan luajit glib gettext-runtime sqlite3

  build_script: cd mail/rspamd-devel && make stage && make check-orphans && make package
  install_run_depends_script: pkg install -y ca_root_nss
  install_script: cd mail/rspamd-devel && make install clean
  run_script: service rspamd onestart
